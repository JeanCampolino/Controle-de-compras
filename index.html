<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Carrinho Inteligente </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* TEMA ESCURO COM GRADIENTE MODERNO VERDE-AZUL */
        body {
            /* GRADIENTE VERDE-AZUL: Azul claro para Azul marinho escuro */
            background: linear-gradient(to right, #1cb5e0, #000046); 
            color: #f8f9fa; 
            min-height: 100vh; /* Ocupa a altura total da tela */
        }

        .container {
            max-width: 600px;
            padding: 20px;
            margin-top: 30px;
        }

        /* CARD PRINCIPAL (Fundo escuro para contraste com o gradiente) */
        .card-view {
            background-color: rgba(109, 122, 134, 0.95); /* Cinza escuro semi-transparente */
            border: 1px solid #bccbdb;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(175, 204, 230, 0.6);
        }

        /* CABE√áALHOS E TEXTO DE DESTAQUE */
        .text-primary, .text-success, h2, h3, h4 {
            color: #79a6e0 !important; /* Azul claro/suave para destaque */
        }

        /* INPUTS */
        .form-control, .input-group-text, .list-group-item {
            background-color: #afbecd;
            color: #f8f9fa;
            border-color: #6c757d;
        }
        .form-control::placeholder {
            color: #adb5bd;
        }

        /* TABELA */
        .table {
            color: #f8f9fa;
        }
        .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: #d2e0f5 !important;
        }
        .table-striped > tbody > tr:nth-of-type(even) > * {
            background-color: #b2cde2 !important;
        }
    </style>
</head>

<body>
    <div id="lista-planejamento-view" class="container card-view" style="display: none;">
        <h2 class="text-center mb-4"> Minha Lista de Planejamento</h2>

        <div class="input-group mb-4">
            <input type="text" id="input-planejamento-item" class="form-control"
                placeholder="Adicionar item (Ex: Sab√£o em P√≥)">
            <button class="btn btn-primary" onclick="adicionarItemPlanejamento()">Adicionar √† Lista</button>
        </div>

        <div id="lista-planejamento-itens" class="list-group">
            </div>

        <button class="btn btn-secondary w-100 mt-4" onclick="alternarVisualizacao('carrinho')">Voltar ao Carrinho</button>
    </div>
    <div class="container card-view" id="carrinho-view">
        <h2 class="text-center"> Carrinho de compras
            <button class="btn btn-info btn-sm float-end" onclick="alternarVisualizacao('planejamento')">Ir para Lista de Planejamento</button>
        </h2>

        <div class="mb-3">
            <label for="produto" class="form-label">Produto</label>
            <input type="text" id="produto" class="form-control">
        </div>
        <div class="mb-3">
            <label for="quantidade" class="form-label">Quantidade</label>
            <input type="number" id="quantidade" class="form-control" value="1" min="1">
        </div>
        <div class="mb-3">
            <label for="preco" class="form-label">Pre√ßo (R$)</label>
            <input type="text" id="preco" class="form-control" placeholder="Ex: 4,98">
        </div>
        <button class="btn btn-primary w-100" onclick="adicionarProduto()">Adicionar Item</button>

        <div class="card my-4 border-success" id="areaSugestoesIA" style="display: none;">
            <div class="card-body p-3">
                <h5 class="card-title text-success mb-2">üí° Sugest√µes de Compra (IA)</h5>
                <p class="card-text small text-muted">Baseado em seus h√°bitos anteriores:</p>
                <div id="listaSugestoes" class="d-flex flex-wrap gap-2">
                </div>
            </div>
        </div>
        
        <h3 class="mt-4">Itens no Carrinho:</h3>
        
        <div class="table-responsive">
            <table class="table table-striped table-sm align-middle">
                <thead>
                    <tr class="table-light">
                        <th>Produto</th>
                        <th style="width: 15%;">Valor (R$)</th>
                        <th style="width: 15%;">Qtd</th>
                        <th style="width: 15%;">Total</th>
                        <th style="width: 10%;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tabela-corpo"></tbody>
            </table>
        </div>
        
        <div id="paginacao" class="mt-3 text-center"></div>
        <h4 class="mt-3 text-end">Subtotal: R$ <span id="subtotal">0,00</span></h4>
        <button class="btn btn-success w-100 mt-3" onclick="finalizarCompra()">Finalizar e Salvar Compra</button>
    </div>

    <script>
        let listaItens = [];
        const itensPorPagina = 10;
        let paginaAtual = 1;
        
        // VARI√ÅVEL COM PERSIST√äNCIA DA LISTA DE PLANEJAMENTO
        let listaPlanejamento = JSON.parse(localStorage.getItem('listaPlanejamento')) || [];

        // FUN√á√ÉO DE ALTERN√ÇNCIA DE P√ÅGINAS
        function alternarVisualizacao(view) {
            const carrinhoView = document.getElementById('carrinho-view');
            const planejamentoView = document.getElementById('lista-planejamento-view');

            if (view === 'planejamento') {
                carrinhoView.style.display = 'none';
                planejamentoView.style.display = 'block';
                renderizarListaPlanejamento(); // ATUALIZA A LISTA AO ENTRAR
            } else {
                carrinhoView.style.display = 'block';
                planejamentoView.style.display = 'none';
                atualizarTabela(); // ATUALIZA O CARRINHO AO VOLTAR
            }
        }

        // FUN√á√ïES DA LISTA DE PLANEJAMENTO
        function adicionarItemPlanejamento() {
            const input = document.getElementById('input-planejamento-item');
            const nomeItem = input.value.trim();

            if (nomeItem) {
                listaPlanejamento.push(nomeItem.charAt(0).toUpperCase() + nomeItem.slice(1));
                localStorage.setItem('listaPlanejamento', JSON.stringify(listaPlanejamento));
                input.value = '';
                renderizarListaPlanejamento();
            }
        }

        function renderizarListaPlanejamento() {
            const container = document.getElementById('lista-planejamento-itens');
            container.innerHTML = '';

            listaPlanejamento.forEach((item, index) => {
                const divItem = document.createElement('div');
                divItem.className = 'list-group-item d-flex justify-content-between align-items-center bg-dark text-light'; 

                const itemInfo = document.createElement('span');
                itemInfo.innerHTML = `
                    ${item} 
                    <button class="btn btn-outline-success btn-sm ms-3" onclick="adicionarAoCarrinhoDoPlanejamento('${item}', ${index})">
                        Adicionar ao Carrinho
                    </button>
                    <button class="btn btn-outline-danger btn-sm ms-1" onclick="removerItemPlanejamento(${index})">
                        Remover
                    </button>
                `;

                divItem.appendChild(itemInfo);
                container.appendChild(divItem);
            });
        }

        function removerItemPlanejamento(index) {
            listaPlanejamento.splice(index, 1);
            localStorage.setItem('listaPlanejamento', JSON.stringify(listaPlanejamento));
            renderizarListaPlanejamento();
        }

        function adicionarAoCarrinhoDoPlanejamento(nome, index) {
            listaItens.push({
                nome: nome,
                quantidade: 1,
                valor: 0.00
            });
            // removerItemPlanejamento(index); // Opcional: Remova este coment√°rio se quiser que o item suma da lista de planejamento ap√≥s ir pro carrinho
            alternarVisualizacao('carrinho');
            atualizarTabela();
        }

        // FUN√á√ïES DE CARRINHO E IA (Inalteradas, apenas otimizadas para o tema)
        function adicionarProduto() {
            let produto = document.getElementById("produto").value;
            let quantidade = parseInt(document.getElementById("quantidade").value);
            let preco = document.getElementById("preco").value.replace(",", ".");

            if (!produto || isNaN(quantidade) || isNaN(parseFloat(preco)) || quantidade < 1) {
                alert("Por favor, preencha todos os campos corretamente.");
                return;
            }

            listaItens.push({
                nome: produto,
                quantidade: quantidade,
                valor: parseFloat(preco)
            });

            document.getElementById("produto").value = "";
            document.getElementById("quantidade").value = "1";
            document.getElementById("preco").value = "";

            atualizarTabela();
        }

        function atualizarTabela() {
            let tabelaCorpo = document.getElementById("tabela-corpo");
            tabelaCorpo.innerHTML = "";

            const inicio = (paginaAtual - 1) * itensPorPagina;
            const fim = inicio + itensPorPagina;
            const itensPaginados = listaItens.slice(inicio, fim);

            itensPaginados.forEach((item, index) => {
                const row = document.createElement("tr");

                row.innerHTML = `
                    <td>${item.nome}</td>
                    
                    <td>
                        <input type="text" 
                                class="form-control form-control-sm editar-valor" 
                                data-index="${inicio + index}" 
                                value="${item.valor.toFixed(2).replace('.', ',')}">
                    </td>

                    <td>
                        <input type="number" 
                                value="${item.quantidade}" 
                                min="1" 
                                class="form-control form-control-sm editar-quantidade" 
                                data-index="${inicio + index}" />
                    </td>
                    
                    <td>R$ ${(item.valor * item.quantidade).toFixed(2).replace('.', ',')}</td>
                    
                    <td><button class="btn btn-danger btn-sm remover-item" data-index="${inicio + index}">Remover</button></td>
                `;

                tabelaCorpo.appendChild(row);
            });

            atualizarPaginacao();
            atualizarSubtotal();
            renderizarSugestoes(); 
        }

        function atualizarPaginacao() {
            let paginacao = document.getElementById("paginacao");
            paginacao.innerHTML = "";
            let totalPaginas = Math.ceil(listaItens.length / itensPorPagina);

            for (let i = 1; i <= totalPaginas; i++) {
                const btn = document.createElement("button");
                btn.className = `btn btn-sm ${i === paginaAtual ? "btn-primary" : "btn-secondary"} mx-1`;
                btn.textContent = i;
                btn.addEventListener("click", () => {
                    paginaAtual = i;
                    atualizarTabela();
                });
                paginacao.appendChild(btn);
            }
        }

        function atualizarSubtotal() {
            let subtotal = listaItens.reduce((acc, item) => acc + item.valor * item.quantidade, 0);
            document.getElementById("subtotal").textContent = subtotal.toFixed(2).replace('.', ',');
        }


        function finalizarCompra() {
            if (listaItens.length === 0) {
                alert("A lista est√° vazia!");
                return;
            }

            let historico = JSON.parse(localStorage.getItem('historicoCompras')) || [];
            const listaAtual = listaItens.map(item => item.nome.toLowerCase().trim());

            historico.push(listaAtual);
            localStorage.setItem('historicoCompras', JSON.stringify(historico));

            listaItens = [];
            paginaAtual = 1;
            atualizarTabela();

            alert("Compra finalizada e hist√≥rico salvo para futura an√°lise de IA!");
            renderizarSugestoes();
        }


        function sugerirItensFrequentes() {
            const historico = JSON.parse(localStorage.getItem('historicoCompras'));

            if (!historico || historico.length < 2) return [];

            const contagemItens = {};
            const itensNaListaAtual = listaItens.map(item => item.nome.toLowerCase().trim());

            historico.flat().forEach(item => {
                const itemNormalizado = item.toLowerCase().trim();

                if (!itensNaListaAtual.includes(itemNormalizado)) {
                    contagemItens[itemNormalizado] = (contagemItens[itemNormalizado] || 0) + 1;
                }
            });

            const itensOrdenados = Object.entries(contagemItens)
                .sort(([, a], [, b]) => b - a);

            return itensOrdenados
                .filter(([_, frequencia]) => frequencia > 1)
                .slice(0, 3)
                .map(([item]) => item.charAt(0).toUpperCase() + item.slice(1));
        }


        function renderizarSugestoes() {
            const sugestoes = sugerirItensFrequentes();
            const listaSugestoes = document.getElementById('listaSugestoes');
            const areaSugestoesIA = document.getElementById('areaSugestoesIA');

            if (sugestoes.length === 0) {
                areaSugestoesIA.style.display = 'none';
                return;
            }

            areaSugestoesIA.style.display = 'block';
            listaSugestoes.innerHTML = '';

            sugestoes.forEach(itemNome => {
                const botao = document.createElement('button');
                botao.className = 'btn btn-outline-success btn-sm';
                botao.innerText = `+ ${itemNome}`;

                botao.onclick = () => {
                    listaItens.push({
                        nome: itemNome,
                        quantidade: 1,
                        valor: 0.00
                    });
                    atualizarTabela();
                };

                listaSugestoes.appendChild(botao);
            });
        }
        
        // NOVO C√ìDIGO: Fun√ß√£o auxiliar para atualizar APENAS o total de uma linha
        function atualizarTotalLinha(inputElement, item) {
            // Encontra a linha (<tr>)
            const row = inputElement.closest('tr');
            if (!row) return;

            // Encontra a c√©lula do 'Total' (que √© a 4¬™ c√©lula, √≠ndice 3)
            const totalCell = row.children[3]; 

            // Calcula o novo total e atualiza a c√©lula
            const novoTotal = (item.valor * item.quantidade).toFixed(2).replace('.', ',');
            totalCell.textContent = `R$ ${novoTotal}`;
        }


        // BLOCO CORRIGIDO: ONDE O ERRO ESTAVA
        document.addEventListener("input", (event) => {
            const target = event.target;
            const index = target.getAttribute("data-index");

            if (target.classList.contains("editar-quantidade")) {
                // 1. Atualiza a quantidade
                listaItens[index].quantidade = parseInt(target.value) || 1;
                
                // 2. Garante que o input n√£o seja menor que 1 (conforme min="1")
                if (listaItens[index].quantidade < 1) {
                     listaItens[index].quantidade = 1;
                     target.value = 1;
                }

                // 3. Atualiza apenas o subtotal e o total da linha (N√ÉO CHAMA atualizarTabela())
                atualizarTotalLinha(target, listaItens[index]);
                atualizarSubtotal();

            } else if (target.classList.contains("editar-valor")) {
                // 1. Limpa e converte o novo valor
                let novoValor = target.value.replace(',', '.');
                
                // 2. Salva o valor no array
                listaItens[index].valor = parseFloat(novoValor) || 0;

                // 3. Atualiza apenas o subtotal e o total da linha (N√ÉO CHAMA atualizarTabela())
                atualizarTotalLinha(target, listaItens[index]);
                atualizarSubtotal();
            }
        });

        document.addEventListener("click", (event) => {
            if (event.target.classList.contains("remover-item")) {
                let index = event.target.getAttribute("data-index");
                listaItens.splice(index, 1);
                // Aqui podemos manter o atualizarTabela() pois a estrutura muda
                atualizarTabela(); 
            }
        });

        // INICIALIZA√á√ÉO CORRETA - DEFINE A P√ÅGINA PADR√ÉO
        window.onload = function () {
            // Garante que a view padr√£o seja o carrinho ao carregar
            alternarVisualizacao('carrinho'); 
        };
    </script>
</body>

</html>