<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Carrinho</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(to right, #ccc, #87CEEB);
        }

        .container {
            margin-top: 50px;
        }
    </style>
</head>

<body>
    <div id="lista-planejamento-view" class="container" style="display: none;">
        <h2 class="text-center mb-4">üìù Minha Lista de Planejamento</h2>

        <div class="input-group mb-4">
            <input type="text" id="input-planejamento-item" class="form-control"
                placeholder="Adicionar item (Ex: Sab√£o em P√≥)">
            <button class="btn btn-primary" onclick="adicionarItemPlanejamento()">Adicionar √† Lista</button>
        </div>

        <div id="lista-planejamento-itens" class="list-group">
            </div>

        <button class="btn btn-secondary w-100 mt-4" onclick="alternarVisualizacao('carrinho')">Voltar ao
            Carrinho</button>
    </div>
    <div class="container" id="carrinho-view">
        <h2 class="text-center"> Carrinho de compras
            <button class="btn btn-info btn-sm float-end" onclick="alternarVisualizacao('planejamento')">Ir para Lista de Planejamento</button>
        </h2>

        <div class="mb-3">
            <label for="produto" class="form-label">Produto</label>
            <input type="text" id="produto" class="form-control">
        </div>
        <div class="mb-3">
            <label for="quantidade" class="form-label">Quantidade</label>
            <input type="number" id="quantidade" class="form-control">
        </div>
        <div class="mb-3">
            <label for="preco" class="form-label">Pre√ßo (R$)</label>
            <input type="text" id="preco" class="form-control" placeholder="Ex: 4,98">
        </div>
        <button class="btn btn-primary w-100" onclick="adicionarProduto()">Adicionar</button>

        <div class="card my-4 border-success" id="areaSugestoesIA" style="display: none;">
            <div class="card-body">
                <h5 class="card-title text-success"> Sugest√µes de Compra </h5>
                <p class="card-text small text-muted">Com base em seus h√°bitos de compra anteriores:</p>
                <div id="listaSugestoes" class="d-flex flex-wrap gap-2">
                </div>
            </div>
        </div>
        <div class="mt-4">
            <h4 class="mb-2">Lista Mestra de Itens</h4>
            <div id="lista-mestra-container" class="d-flex flex-wrap gap-2">
            </div>
        </div>
        
        <h3 class="mt-4">Itens:</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Valor (R$)</th>
                    <th>Quantidade</th>
                    <th>Total</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="tabela-corpo"></tbody>
        </table>
        <div id="paginacao" class="mt-3"></div>
        <h4 class="mt-3">Subtotal: R$ <span id="subtotal">0,00</span></h4>
        <button class="btn btn-success w-100 mt-3" onclick="finalizarCompra()">Finalizar e Salvar Compra</button>
    </div>

    <script>
        let listaItens = [];
        const itensPorPagina = 10;
        let paginaAtual = 1;
        
        // VARI√ÅVEIS COM PERSIST√äNCIA CORRIGIDA
        let listaMestra = JSON.parse(localStorage.getItem('listaMestra')) || ["P√£o", "Leite", "Manteiga", "Caf√©", "A√ß√∫car", "Arroz", "Feij√£o", "Frutas"];
        let listaPlanejamento = JSON.parse(localStorage.getItem('listaPlanejamento')) || [];

        // FUN√á√ÉO DE ALTERN√ÇNCIA DE P√ÅGINAS
        function alternarVisualizacao(view) {
            const carrinhoView = document.getElementById('carrinho-view');
            const planejamentoView = document.getElementById('lista-planejamento-view');

            if (view === 'planejamento') {
                carrinhoView.style.display = 'none';
                planejamentoView.style.display = 'block';
                renderizarListaPlanejamento(); // ATUALIZA A LISTA AO ENTRAR
            } else {
                carrinhoView.style.display = 'block';
                planejamentoView.style.display = 'none';
                atualizarTabela(); // ATUALIZA O CARRINHO AO VOLTAR
            }
        }

        // FUN√á√ïES DA LISTA DE PLANEJAMENTO (INCOMPLETAS NO C√ìDIGO ANTERIOR)
        function adicionarItemPlanejamento() {
            const input = document.getElementById('input-planejamento-item');
            const nomeItem = input.value.trim();

            if (nomeItem) {
                listaPlanejamento.push(nomeItem.charAt(0).toUpperCase() + nomeItem.slice(1));
                localStorage.setItem('listaPlanejamento', JSON.stringify(listaPlanejamento));
                input.value = '';
                renderizarListaPlanejamento();
            }
        }

        function renderizarListaPlanejamento() {
            const container = document.getElementById('lista-planejamento-itens');
            container.innerHTML = '';

            listaPlanejamento.forEach((item, index) => {
                const divItem = document.createElement('div');
                divItem.className = 'list-group-item d-flex justify-content-between align-items-center';

                const itemInfo = document.createElement('span');
                itemInfo.innerHTML = `
                    ${item} 
                    <button class="btn btn-outline-success btn-sm ms-3" onclick="adicionarAoCarrinhoDoPlanejamento('${item}', ${index})">
                        Adicionar ao Carrinho
                    </button>
                    <button class="btn btn-outline-danger btn-sm ms-1" onclick="removerItemPlanejamento(${index})">
                        Remover
                    </button>
                `;

                divItem.appendChild(itemInfo);
                container.appendChild(divItem);
            });
        }

        function removerItemPlanejamento(index) {
            listaPlanejamento.splice(index, 1);
            localStorage.setItem('listaPlanejamento', JSON.stringify(listaPlanejamento));
            renderizarListaPlanejamento();
        }

        function adicionarAoCarrinhoDoPlanejamento(nome, index) {
            listaItens.push({
                nome: nome,
                quantidade: 1,
                valor: 0.00
            });
            removerItemPlanejamento(index);
            alternarVisualizacao('carrinho');
            atualizarTabela();
        }

        // FUN√á√ïES EXISTENTES
        function adicionarProduto() {
            let produto = document.getElementById("produto").value;
            let quantidade = parseInt(document.getElementById("quantidade").value);
            let preco = document.getElementById("preco").value.replace(",", ".");

            if (!produto || isNaN(quantidade) || isNaN(parseFloat(preco))) {
                alert("Por favor, preencha todos os campos corretamente.");
                return;
            }

            listaItens.push({
                nome: produto,
                quantidade: quantidade,
                valor: parseFloat(preco)
            });

            document.getElementById("produto").value = "";
            document.getElementById("quantidade").value = "";
            document.getElementById("preco").value = "";

            atualizarTabela();
        }

        function atualizarTabela() {
            let tabelaCorpo = document.getElementById("tabela-corpo");
            tabelaCorpo.innerHTML = "";

            const inicio = (paginaAtual - 1) * itensPorPagina;
            const fim = inicio + itensPorPagina;
            const itensPaginados = listaItens.slice(inicio, fim);

            itensPaginados.forEach((item, index) => {
                const row = document.createElement("tr");

                row.innerHTML = `
                    <td>${item.nome}</td>
                    
                    <td>
                        <input type="text" 
                               class="form-control editar-valor" 
                               data-index="${inicio + index}" 
                               value="${item.valor.toFixed(2).replace('.', ',')}">
                    </td>

                    <td>
                        <input type="number" 
                               value="${item.quantidade}" 
                               min="1" 
                               class="editar-quantidade" 
                               data-index="${inicio + index}" />
                    </td>
                    
                    <td>R$ ${(item.valor * item.quantidade).toFixed(2).replace('.', ',')}</td>
                    
                    <td><button class="btn btn-danger btn-sm remover-item" data-index="${inicio + index}">Remover</button></td>
                `;

                tabelaCorpo.appendChild(row);
            });

            atualizarPaginacao();
            atualizarSubtotal();
            renderizarSugestoes(); 
            renderizarListaMestra(); // Mantive para a se√ß√£o de favoritos (Lista Mestra)
        }

        function atualizarPaginacao() {
            let paginacao = document.getElementById("paginacao");
            paginacao.innerHTML = "";
            let totalPaginas = Math.ceil(listaItens.length / itensPorPagina);

            for (let i = 1; i <= totalPaginas; i++) {
                const btn = document.createElement("button");
                btn.className = `btn btn-sm ${i === paginaAtual ? "btn-primary" : "btn-secondary"}`;
                btn.textContent = i;
                btn.addEventListener("click", () => {
                    paginaAtual = i;
                    atualizarTabela();
                });
                paginacao.appendChild(btn);
            }
        }

        function atualizarSubtotal() {
            let subtotal = listaItens.reduce((acc, item) => acc + item.valor * item.quantidade, 0);
            document.getElementById("subtotal").textContent = subtotal.toFixed(2).replace('.', ',');
        }


        function finalizarCompra() {
            if (listaItens.length === 0) {
                alert("A lista est√° vazia!");
                return;
            }

            let historico = JSON.parse(localStorage.getItem('historicoCompras')) || [];
            const listaAtual = listaItens.map(item => item.nome.toLowerCase().trim());

            historico.push(listaAtual);
            localStorage.setItem('historicoCompras', JSON.stringify(historico));

            listaItens = [];
            paginaAtual = 1;
            atualizarTabela();

            alert("Compra finalizada e hist√≥rico salvo para futura an√°lise de IA!");
            renderizarSugestoes();
        }



        function sugerirItensFrequentes() {
            const historico = JSON.parse(localStorage.getItem('historicoCompras'));

            if (!historico || historico.length < 2) return [];

            const contagemItens = {};
            const itensNaListaAtual = listaItens.map(item => item.nome.toLowerCase().trim());

            historico.flat().forEach(item => {
                const itemNormalizado = item.toLowerCase().trim();

                if (!itensNaListaAtual.includes(itemNormalizado)) {
                    contagemItens[itemNormalizado] = (contagemItens[itemNormalizado] || 0) + 1;
                }
            });

            const itensOrdenados = Object.entries(contagemItens)
                .sort(([, a], [, b]) => b - a);

            return itensOrdenados
                .filter(([_, frequencia]) => frequencia > 1)
                .slice(0, 3)
                .map(([item]) => item.charAt(0).toUpperCase() + item.slice(1));
        }


        function renderizarSugestoes() {
            const sugestoes = sugerirItensFrequentes();
            const listaSugestoes = document.getElementById('listaSugestoes');
            const areaSugestoesIA = document.getElementById('areaSugestoesIA');

            if (sugestoes.length === 0) {
                areaSugestoesIA.style.display = 'none';
                return;
            }

            areaSugestoesIA.style.display = 'block';
            listaSugestoes.innerHTML = '';

            sugestoes.forEach(itemNome => {
                const botao = document.createElement('button');
                botao.className = 'btn btn-outline-success btn-sm';
                botao.innerText = `+ ${itemNome}`;

                botao.onclick = () => {
                    listaItens.push({
                        nome: itemNome,
                        quantidade: 1,
                        valor: 0.00
                    });
                    atualizarTabela();
                };

                listaSugestoes.appendChild(botao);
            });
        }
        
        function renderizarListaMestra() {
            const listaMestraContainer = document.getElementById("lista-mestra-container");
            listaMestraContainer.innerHTML = ''; 

            listaMestra.forEach(itemNome => {
                const divItem = document.createElement('div');
                divItem.className = 'd-flex align-items-center gap-1'; 

                const inputQtd = document.createElement('input');
                inputQtd.type = 'number';
                inputQtd.value = '1';
                inputQtd.min = '1';
                inputQtd.style.width = '60px'; 
                inputQtd.className = 'form-control form-control-sm';
                
                const botao = document.createElement('button');
                botao.className = 'btn btn-primary btn-sm';
                botao.innerText = `+ ${itemNome}`;
                
                botao.onclick = () => {
                    const quantidadeSelecionada = parseInt(inputQtd.value) || 1; 

                    listaItens.push({
                        nome: itemNome,
                        quantidade: quantidadeSelecionada,
                        valor: 0.00 
                    });
                    atualizarTabela();
                };

                divItem.appendChild(inputQtd);
                divItem.appendChild(botao);
                listaMestraContainer.appendChild(divItem);
            });
        }


        document.addEventListener("input", (event) => {
            if (event.target.classList.contains("editar-quantidade")) {
                let index = event.target.getAttribute("data-index");
                listaItens[index].quantidade = parseInt(event.target.value);
                atualizarTabela();
            } 
            else if (event.target.classList.contains("editar-valor")) {
                let index = event.target.getAttribute("data-index");

                let novoValor = event.target.value.replace(',', '.');
                listaItens[index].valor = parseFloat(novoValor) || 0;

                atualizarTabela();
            }
        });

        document.addEventListener("click", (event) => {
            if (event.target.classList.contains("remover-item")) {
                let index = event.target.getAttribute("data-index");
                listaItens.splice(index, 1);
                atualizarTabela();
            }
        });

        // INICIALIZA√á√ÉO CORRETA - DEFINE A P√ÅGINA PADR√ÉO
        window.onload = function () {
            // Garante que a view padr√£o seja o carrinho ao carregar
            alternarVisualizacao('carrinho'); 
        };
    </script>
</body>

</html>